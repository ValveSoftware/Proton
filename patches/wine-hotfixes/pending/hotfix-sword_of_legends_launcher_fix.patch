From: Paul Gofman <pgofman@codeweavers.com>
Subject: [PATCH 1/2] mshtml: Do not lock document mode in create_document_event().
Message-Id: <20210721204432.190323-1-pgofman@codeweavers.com>
Date: Wed, 21 Jul 2021 23:44:31 +0300

Event may be created before the document is loaded.

Signed-off-by: Paul Gofman <pgofman@codeweavers.com>
---
 dlls/mshtml/htmlevent.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/dlls/mshtml/htmlevent.c b/dlls/mshtml/htmlevent.c
index 17f5fb35b71..5b040c4df62 100644
--- a/dlls/mshtml/htmlevent.c
+++ b/dlls/mshtml/htmlevent.c
@@ -2334,7 +2334,7 @@ HRESULT create_document_event(HTMLDocumentNode *doc, eventid_t event_id, DOMEven
         return E_FAIL;
     }
 
-    event = alloc_event(nsevent, dispex_compat_mode(&doc->node.event_target.dispex), event_id);
+    event = alloc_event(nsevent, doc->document_mode, event_id);
     if(!event)
         return E_OUTOFMEMORY;
 

-- 
2.31.1

From: Paul Gofman <pgofman@codeweavers.com>
Subject: [PATCH 2/2] mshtml: Default to IE11 for Internet URL zone.
Message-Id: <20210721204432.190323-2-pgofman@codeweavers.com>
Date: Wed, 21 Jul 2021 23:44:32 +0300
In-Reply-To: <20210721204432.190323-1-pgofman@codeweavers.com>
References: <20210721204432.190323-1-pgofman@codeweavers.com>

Fixes Swords of Legends Online launcher.

Signed-off-by: Paul Gofman <pgofman@codeweavers.com>
---
 dlls/mshtml/mutation.c | 9 ++-------
 1 file changed, 2 insertions(+), 7 deletions(-)

diff --git a/dlls/mshtml/mutation.c b/dlls/mshtml/mutation.c
index abe403ea976..4352e93eba3 100644
--- a/dlls/mshtml/mutation.c
+++ b/dlls/mshtml/mutation.c
@@ -828,15 +828,10 @@ static void NSAPI nsDocumentObserver_BindToDocument(nsIDocumentObserver *iface,
                 DWORD zone;
                 HRESULT hres;
 
-                /*
-                 * Internet URL zone is treated differently. Native defaults to latest supported
-                 * mode. We default to IE8. Ideally, we'd sync that with version used for IE=edge
-                 * X-UA-Compatible version, allow configuration and default to higher version
-                 * (once it's well supported).
-                 */
+                /* Internet URL zone is treated differently and defaults to the latest supported mode. */
                 hres = IInternetSecurityManager_MapUrlToZone(get_security_manager(), window->url, &zone, 0);
                 if(SUCCEEDED(hres) && zone == URLZONE_INTERNET)
-                    mode = COMPAT_MODE_IE8;
+                    mode = COMPAT_MODE_IE11;
             }
 
             set_document_mode(This, mode, FALSE);

-- 
2.31.1


